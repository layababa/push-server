# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PushApp AI å®¡æŸ¥å·¥ä½œæµ â€” Server
# AI åˆ©ç”¨æŒ‡å®š prompt ç‹¬ç«‹å®¡æŸ¥ PR
# P0/P1 â†’ FAIL é˜»æ­¢åˆå¹¶
# P2/P3 â†’ PASS ä½†è‡ªåŠ¨è®°å½•åˆ° docs/modules/<module>/improvements.md
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    # ä¸è®¾ paths è¿‡æ»¤ â€” ç¡®ä¿æ¯ä¸ª PR éƒ½äº§ç”Ÿ status checkï¼Œé¿å…åˆ†æ”¯ä¿æŠ¤æ­»é”
    # Kotlin å˜æ›´æ£€æµ‹åœ¨ job å†…éƒ¨å®Œæˆï¼Œé Kotlin PR è‡ªåŠ¨ pass

# åŒä¸€ PR çš„æ–° push è‡ªåŠ¨å–æ¶ˆæ—§çš„å®¡æŸ¥
concurrency:
  group: ai-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  # push_docs ä»“åº“ä¿¡æ¯
  DOCS_REPO: ${{ github.repository_owner }}/push_docs
  DOCS_REF: main

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job: AI Code Review
  # è´Ÿè´£ç›´æ¥å®¡æŸ¥ PR å¹¶åœ¨ PR è¯„è®ºä¸­åé¦ˆï¼ŒåŒæ—¶å°† P2/P3 é—®é¢˜å†™å…¥ improvements.md
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ai-reviewer:
    name: "ğŸ¤– AI Code Review"
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: Checkout å½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout push_docs (å®¡æŸ¥ prompt + è„šæœ¬ + å†™å…¥ improvements)
        uses: actions/checkout@v4
        with:
          repository: ${{ env.DOCS_REPO }}
          ref: ${{ env.DOCS_REF }}
          token: ${{ secrets.DOOR_REPO_READ_TOKEN }}
          path: _docs

      - name: æå– PR Diff (ä»… Kotlin ä»£ç æ–‡ä»¶)
        run: |
          git diff origin/${{ github.event.pull_request.base.ref }}...HEAD \
            -- '*.kt' > diff.txt
          echo "Diff size: $(wc -c < diff.txt) bytes"
          if [ ! -s diff.txt ]; then
            echo "skip=true" >> $GITHUB_ENV
          fi

      - name: å®‰è£… Python ä¾èµ–
        if: env.skip != 'true'
        run: pip install -r _docs/ci/scripts/requirements.txt

      - name: æ‰§è¡Œ AI å®¡æŸ¥ (å« improvements.md å†™å…¥)
        if: env.skip != 'true'
        env:
          AI_CODE_WITH_KEY: ${{ secrets.AI_CODE_WITH_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python _docs/ci/scripts/ai_review.py \
            --prompt _docs/ci/review-prompts/server-review-prompt.md \
            --diff diff.txt \
            --reviewer-name "PushApp AI å®¡æŸ¥å‘˜" \
            --temperature 0.2 \
            --docs-dir _docs \
            --commit "${{ github.event.pull_request.head.sha }}" \
            --author "${{ github.event.pull_request.user.login }}"

      # P2/P3 é—®é¢˜å†™å…¥ improvements.md åï¼Œè‡ªåŠ¨æäº¤å› push_docs
      - name: æäº¤ improvements.md åˆ° push_docs
        if: env.skip != 'true'
        run: |
          cd _docs
          if git diff --quiet; then
            echo "[INFO] æ—  P2/P3 é—®é¢˜ï¼Œæ— éœ€æäº¤"
          else
            git config user.name "AI Code Review Bot"
            git config user.email "ai-review-bot@pushapp.dev"
            git add modules/*/improvements.md
            git commit -m "docs: AI å®¡æŸ¥è®°å½• P2/P3 æ”¹è¿›å»ºè®® (PR #${{ github.event.pull_request.number }})"
            git push
            echo "[OK] improvements.md å·²æäº¤åˆ° push_docs"
          fi
